<!DOCTYPE html>

<!-- ... existing HTML omitted for brevity ... -->
<script>
  document.addEventListener('DOMContentLoaded', initHeaderAuth);

  // Back link behavior preserved
  const link = document.querySelector('a[href="/home"]');
  if (link) {
    link.addEventListener('click', function (e) {
      if (document.referrer && document.referrer.startsWith(location.origin)) {
        e.preventDefault();
        history.back();
      }
    });
  }

  // Get recipe ID from URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const recipeId = urlParams.get('id');
  if (!recipeId) {
    showError('No recipe ID provided in URL.');
  } else {
    fetchRecipeDetails(recipeId);
  }

  async function fetchRecipeDetails(id) {
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const recipeContent = document.getElementById('recipeContent');

    try {
      loading.style.display = 'block';
      error.style.display = 'none';
      recipeContent.style.display = 'none';

      const response = await fetch(`/api/recipe?id=${encodeURIComponent(id)}`);

      // If HTTP not ok, attempt to read JSON error safely only if JSON; otherwise show friendly message
      const contentType = response.headers.get('content-type') || '';

      if (!response.ok) {
        if (contentType.includes('application/json')) {
          // Try to parse structured error payload
          const errJson = await response.json().catch(() => null);
          const msg = errJson?.message || errJson?.error || `Request failed with status ${response.status}`;
          throw new Error(msg);
        } else {
          // Do not attempt to parse HTML/text bodies
          throw new Error(`Request failed with status ${response.status}. Please try again later.`);
        }
      }

      // Only parse JSON if content-type is application/json
      if (!contentType.includes('application/json')) {
        // Avoid parsing HTML; show friendly preview-free message
        throw new Error('Unexpected server response format. Please try again later.');
      }

      const data = await response.json();

      // If backend returns JSON error in a 200, handle it
      if (data && (data.error || data.message) && !data.name) {
        const msg = data.message || data.error || 'An unknown error occurred.';
        throw new Error(msg);
      }

      if (!data || !data.name) {
        throw new Error('Invalid recipe data received.');
      }

      displayRecipe(data);
      loading.style.display = 'none';
      recipeContent.style.display = 'block';
    } catch (err) {
      console.error('Error fetching recipe:', err);
      showError(`Failed to load recipe: ${err.message}`);
    }
  }

  function displayRecipe(recipe) {
    const {
      name: recipeName,
      category,
      difficulty,
      servings,
      prepTime,
      cookTime,
      totalTime,
      ingredients = [],
      instructions = [],
      imageUrl,
      author
    } = recipe;

    const recipeHTML = `
      <div class="recipe-header">
        <h1>${escapeHtml(recipeName)}</h1>
        <div class="recipe-meta">
          ${category ? `<span class="badge badge-category">${escapeHtml(category)}</span>` : ''}
          ${difficulty ? `<span class="badge badge-difficulty">${escapeHtml(difficulty)}</span>` : ''}
        </div>
      </div>

      ${imageUrl ? `<img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(recipeName)}" class="recipe-image">` : ''}

      <div class="recipe-content">
        ${(servings || prepTime || cookTime || totalTime) ? `
          <div class="info-grid">
          ${servings ? `
            <div class="info-card">
              <strong>Servings</strong>
              <span>${escapeHtml(String(servings))}</span>
            </div>
          ` : ''}
          ${prepTime ? `
            <div class="info-card">
              <strong>Prep Time</strong>
              <span>${escapeHtml(String(prepTime))} min</span>
            </div>
          ` : ''}
          ${cookTime ? `
            <div class="info-card">
              <strong>Cook Time</strong>
              <span>${escapeHtml(String(cookTime))} min</span>
            </div>
          ` : ''}
          ${totalTime ? `
            <div class="info-card">
              <strong>Total Time</strong>
              <span>${escapeHtml(String(totalTime))} min</span>
            </div>
          ` : ''}
          </div>
        ` : ''}

        ${ingredients.length > 0 ? `
          <div class="recipe-section">
            <h2>Ingredients</h2>
            <ul class="ingredients-list">
              ${ingredients.map(ingredient => `<li>${escapeHtml(ingredient)}</li>`).join('')}
            </ul>
          </div>
        ` : '<div class="recipe-section"><h2>Ingredients</h2><p>No ingredients listed.</p></div>'}

        ${instructions.length > 0 ? `
          <div class="recipe-section">
            <h2>Instructions</h2>
            <ol class="instructions-list">
              ${instructions.map(instruction => `<li>${escapeHtml(instruction)}</li>`).join('')}
            </ol>
          </div>
        ` : '<div class="recipe-section"><h2>Instructions</h2><p>No instructions provided.</p></div>'}

        ${author ? `
          <div class="author-info">
            <strong>Recipe by:</strong> ${escapeHtml(author)}
          </div>
        ` : ''}
      </div>
    `;

    document.getElementById('recipeContent').innerHTML = recipeHTML;
    document.title = `${recipeName} - Family Recipe Collection`;
  }

  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = String(text);
    return div.innerHTML;
  }

  function showError(message) {
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const recipeContent = document.getElementById('recipeContent');

    loading.style.display = 'none';
    error.textContent = message;
    error.style.display = 'block';
    recipeContent.style.display = 'none';
  }
</script>
