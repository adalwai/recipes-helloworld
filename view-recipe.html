<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Recipe Details - Family Recipe Collection</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
      .back-link { display: inline-block; color: white; text-decoration: none; padding: 10px 20px; background-color: rgba(255, 255, 255, 0.2); border-radius: 5px; margin-bottom: 20px; transition: background-color 0.3s; }
      .back-link:hover { background-color: rgba(255, 255, 255, 0.3); }
      .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); overflow: hidden; }
      .recipe-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; text-align: center; }
      .recipe-header h1 { font-size: 2.5em; margin-bottom: 10px; }
      .recipe-meta { display: flex; justify-content: center; gap: 30px; margin-top: 20px; flex-wrap: wrap; }
      .meta-item { display: flex; flex-direction: column; align-items: center; }
      .meta-item strong { font-size: 1.2em; margin-bottom: 5px; }
      .recipe-image { width: 100%; height: 400px; object-fit: cover; }
      .recipe-content { padding: 40px; }
      .recipe-section { margin-bottom: 30px; }
      .recipe-section h2 { color: #667eea; margin-bottom: 15px; font-size: 1.8em; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
      .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
      .info-card { background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; }
      .info-card strong { display: block; color: #667eea; margin-bottom: 5px; font-size: 0.9em; }
      .info-card span { font-size: 1.2em; color: #333; }
      .ingredients-list, .instructions-list { background: #f8f9fa; padding: 20px; border-radius: 10px; }
      .ingredients-list li, .instructions-list li { padding: 10px; margin-bottom: 10px; background: white; border-radius: 5px; list-style-position: inside; }
      .instructions-list li { border-left: 4px solid #667eea; padding-left: 15px; }
      .badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold; }
      .badge-category { background: #e3f2fd; color: #1976d2; }
      .badge-difficulty { background: #fff3e0; color: #f57c00; }
      .loading { text-align: center; padding: 100px; font-size: 1.5em; color: #667eea; }
      .error { text-align: center; padding: 100px; color: #d32f2f; font-size: 1.2em; }
      .author-info { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 30px; text-align: center; }
      .author-info strong { color: #667eea; }
    </style>
  </head>
  <body>
    <div id="userInfo" style="position:fixed; top:12px; right:12px; background:#f4f4f5; padding:6px 10px; border-radius:16px; font-size:14px; visibility:hidden; opacity:0;"><span id="userName"></span></div>
    <a class="back-link" href="index.html">‚Üê Back to Home</a>
    <div class="container">
      <div id="loading" class="loading">Loading recipe...</div>
      <div id="error" class="error" style="display: none;"></div>
      <div id="recipeContent" style="display: none;"></div>
    </div>

    <script>
      // Get recipe ID from URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const recipeId = urlParams.get('id');
      if (!recipeId) {
        showError('No recipe ID provided in URL.');
      } else {
        fetchRecipeDetails(recipeId);
      }
      async function fetchRecipeDetails(id) {
        try {
          const response = await fetch(`/api/recipes?id=${id}`);
          if (!response.ok) {
            const statusText = response.statusText || 'Unknown error';
            throw new Error(`Failed to fetch recipe (${response.status}: ${statusText})`);
          }
          const recipe = await response.json();
          if (!recipe || typeof recipe !== 'object') {
            throw new Error('Invalid recipe data received from server.');
          }
          displayRecipe(recipe);
        } catch (error) {
          console.error('Error fetching recipe:', error);
          showError(`Failed to load recipe: ${error.message}`);
        }
      }
      function showError(message) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').textContent = message;
      }
      function displayRecipe(recipe) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('recipeContent').style.display = 'block';
        const recipeName = recipe.title || recipe.recipeName || recipe.name || 'Untitled Recipe';
        let ingredients = [];
        if (recipe.ingredients) {
          if (typeof recipe.ingredients === 'string') {
            ingredients = recipe.ingredients.split('\n').filter(i => i.trim());
          } else if (Array.isArray(recipe.ingredients)) {
            ingredients = recipe.ingredients.filter(i => i && i.trim());
          }
        }
        let instructions = [];
        if (recipe.instructions) {
          if (typeof recipe.instructions === 'string') {
            instructions = recipe.instructions.split('\n').filter(i => i.trim());
          } else if (Array.isArray(recipe.instructions)) {
            instructions = recipe.instructions.filter(i => i && i.trim());
          }
        }
        const servings = recipe.servings || recipe.serving || null;
        const prepTime = recipe.prepTime || recipe.prep_time || null;
        const cookTime = recipe.cookTime || recipe.cook_time || null;
        const category = recipe.category || null;
        const difficulty = recipe.difficulty || null;
        const author = recipe.author || null;
        const imageUrl = recipe.image_url || recipe.imageUrl || recipe.image || null;
        let totalTime = null;
        if (prepTime && cookTime) {
          const prep = parseInt(prepTime); const cook = parseInt(cookTime);
          if (!isNaN(prep) && !isNaN(cook)) { totalTime = prep + cook; }
        }
        const recipeHTML = `
          <div class="recipe-header">
            <h1>${escapeHtml(recipeName)}</h1>
            <div class="recipe-meta">
              ${category ? `<span class="badge badge-category">${escapeHtml(category)}</span>` : ''}
              ${difficulty ? `<span class="badge badge-difficulty">${escapeHtml(difficulty)}</span>` : ''}
            </div>
          </div>
          ${imageUrl ? `<img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(recipeName)}" class="recipe-image">` : ''}
          <div class="recipe-content">
            ${servings || prepTime || cookTime || totalTime ? `
            <div class="info-grid">
              ${servings ? `
                <div class="info-card">
                  <strong>Servings</strong>
                  <span>${escapeHtml(String(servings))}</span>
                </div>
              ` : ''}
              ${prepTime ? `
                <div class="info-card">
                  <strong>Prep Time</strong>
                  <span>${escapeHtml(String(prepTime))} min</span>
                </div>
              ` : ''}
              ${cookTime ? `
                <div class="info-card">
                  <strong>Cook Time</strong>
                  <span>${escapeHtml(String(cookTime))} min</span>
                </div>
              ` : ''}
              ${totalTime ? `
                <div class="info-card">
                  <strong>Total Time</strong>
                  <span>${totalTime} min</span>
                </div>
              ` : ''}
            </div>
            ` : ''}
            ${ingredients.length > 0 ? `
              <div class="recipe-section">
                <h2>Ingredients</h2>
                <ul class="ingredients-list">
                  ${ingredients.map(ingredient => `<li>${escapeHtml(ingredient)}</li>`).join('')}
                </ul>
              </div>
            ` : '<div class="recipe-section"><h2>Ingredients</h2><p>No ingredients listed.</p></div>'}
            ${instructions.length > 0 ? `
              <div class="recipe-section">
                <h2>Instructions</h2>
                <ol class="instructions-list">
                  ${instructions.map(instruction => `<li>${escapeHtml(instruction)}</li>`).join('')}
                </ol>
              </div>
            ` : '<div class="recipe-section"><h2>Instructions</h2><p>No instructions provided.</p></div>'}
            ${author ? `
              <div class="author-info">
                <strong>Recipe by:</strong> ${escapeHtml(author)}
              </div>
            ` : ''}
          </div>
        `;
        document.getElementById('recipeContent').innerHTML = recipeHTML;
        document.title = `${recipeName} - Family Recipe Collection`;
      }
      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
      }
    </script>
    <script src="/functions/api/header.js"></script>
    <script>document.addEventListener('DOMContentLoaded', initHeaderAuth);</script>
  </body>
</html>
